# TrendPulse æ•°æ®åº“è¡¨è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. æ•°æ®åº“é€‰å‹](#2-æ•°æ®åº“é€‰å‹)
- [3. ER å›¾](#3-er-å›¾)
- [4. è¡¨ç»“æ„è¯¦è§£](#4-è¡¨ç»“æ„è¯¦è§£)
  - [4.1 keywords è¡¨](#41-keywords-è¡¨)
  - [4.2 posts è¡¨](#42-posts-è¡¨)
  - [4.3 opinion_clusters è¡¨](#43-opinion_clusters-è¡¨)
  - [4.4 analysis_jobs è¡¨](#44-analysis_jobs-è¡¨)
  - [4.5 subscriptions è¡¨](#45-subscriptions-è¡¨)
  - [4.6 alerts è¡¨](#46-alerts-è¡¨)
- [5. ç´¢å¼•è®¾è®¡](#5-ç´¢å¼•è®¾è®¡)
- [6. æ•°æ®æµ](#6-æ•°æ®æµ)
- [7. SQL ç¤ºä¾‹](#7-sql-ç¤ºä¾‹)
- [8. æ€§èƒ½ä¼˜åŒ–](#8-æ€§èƒ½ä¼˜åŒ–)
- [9. å¤‡ä»½ä¸æ¢å¤](#9-å¤‡ä»½ä¸æ¢å¤)

---

## 1. æ¦‚è¿°

TrendPulse ä½¿ç”¨å…³ç³»å‹æ•°æ®åº“å­˜å‚¨ç¤¾äº¤åª’ä½“é‡‡é›†æ•°æ®å’Œ AI åˆ†æç»“æœã€‚æ•°æ®åº“è®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

- **è§„èŒƒåŒ–è®¾è®¡**: æ¶ˆé™¤æ•°æ®å†—ä½™ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- **å¤–é”®çº¦æŸ**: ç¡®ä¿å¼•ç”¨å®Œæ•´æ€§
- **æ—¶é—´æˆ³**: è®°å½•æ•°æ®åˆ›å»ºå’Œæ›´æ–°æ—¶é—´
- **è½¯åˆ é™¤**: ä½¿ç”¨ `is_active` å­—æ®µè€Œéç‰©ç†åˆ é™¤

### æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ |
|------|---------|------|
| æ•°æ®åº“ | SQLite | 3.x |
| ORM | SQLAlchemy | 2.0+ |
| å¼‚æ­¥é©±åŠ¨ | aiosqlite | 0.19+ |
| è¿æ¥å­—ç¬¦ä¸² | `sqlite+aiosqlite:///./trendpulse.db` | - |

---

## 2. æ•°æ®åº“é€‰å‹

### å½“å‰æ–¹æ¡ˆ: SQLite

**ä¼˜åŠ¿**:
- âœ… é›¶é…ç½®ï¼Œæ— éœ€ç‹¬ç«‹æ•°æ®åº“æœåŠ¡å™¨
- âœ… è½»é‡çº§ï¼Œé€‚åˆå¼€å‘å’ŒåŸå‹é˜¶æ®µ
- âœ… å•æ–‡ä»¶å­˜å‚¨ï¼Œæ˜“äºå¤‡ä»½å’Œè¿ç§»
- âœ… æ”¯æŒ SQL æ ‡å‡†è¯­æ³•

**é™åˆ¶**:
- âš ï¸ ä¸æ”¯æŒé«˜å¹¶å‘å†™æ“ä½œ
- âš ï¸ å•æœºéƒ¨ç½²ï¼Œæ— æ³•æ¨ªå‘æ‰©å±•
- âš ï¸ ä¸æ”¯æŒéƒ¨åˆ†é«˜çº§åŠŸèƒ½ï¼ˆå¦‚å­˜å‚¨è¿‡ç¨‹ï¼‰

### ç”Ÿäº§ç¯å¢ƒå»ºè®®: PostgreSQL

**è¿ç§»ä¼˜åŠ¿**:
- âœ… æ›´å¥½çš„å¹¶å‘æ€§èƒ½
- âœ… æ”¯æŒ JSONB ç±»å‹ï¼ˆçµæ´»å­˜å‚¨ï¼‰
- âœ… å…¨æ–‡æœç´¢èƒ½åŠ›ï¼ˆFTSï¼‰
- âœ… æ›´å¼ºçš„æ•°æ®ä¸€è‡´æ€§ä¿è¯
- âœ… æ”¯æŒè¿æ¥æ± å’Œå¤åˆ¶

**è¿ç§»æ­¥éª¤**:
```python
# 1. å®‰è£…ä¾èµ–
pip install asyncpg

# 2. ä¿®æ”¹è¿æ¥å­—ç¬¦ä¸²
DATABASE_URL=postgresql+asyncpg://user:pass@localhost/trendpulse

# 3. è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬
python scripts/migrate_to_postgres.py
```

---

## 3. ER å›¾

```mermaid
erDiagram
    %% ========== å®ä½“å®šä¹‰ ==========
    Keyword {
        int id PK
        string keyword UK
        string language
        float overall_sentiment
        text summary
        datetime last_analyzed
        datetime created_at
    }

    Post {
        int id PK
        string platform
        string post_id
        string author
        text content
        string url
        int upvotes
        int likes
        int shares
        int comments_count
        float sentiment_score
        string sentiment_label
        datetime created_at
        datetime collected_at
        int keyword_id FK
    }

    OpinionCluster {
        int id PK
        int keyword_id FK
        string cluster_label
        text cluster_summary
        int representative_post_id FK
        int mention_count
        datetime created_at
    }

    AnalysisJob {
        int id PK
        int keyword_id FK
        string status
        string platforms_scraped
        int posts_collected
        int token_used
        text error_message
        datetime started_at
        datetime completed_at
    }

    Subscription {
        int id PK
        int keyword_id FK
        string platforms
        string language
        int post_limit
        float alert_threshold
        int interval_hours
        boolean is_active
        datetime created_at
        datetime last_checked_at
        datetime next_check_at
        string user_email
    }

    Alert {
        int id PK
        int subscription_id FK
        int keyword_id FK
        float sentiment_score
        string sentiment_label
        int posts_count
        int negative_posts_count
        text summary
        text top_negative_posts
        boolean is_sent
        datetime sent_at
        datetime created_at
        datetime acknowledged_at
    }

    %% ========== å…³ç³»å®šä¹‰ ==========
    Keyword ||--o{ Post : "has many"
    Keyword ||--o{ OpinionCluster : "has many"
    Keyword ||--o{ AnalysisJob : "has many"
    Keyword ||--o{ Subscription : "has many"
    Keyword ||--o{ Alert : "has many"

    Post ||--o| OpinionCluster : "may represent"
    Subscription ||--o{ Alert : "triggers"
```

### å…³ç³»è¯´æ˜

| å…³ç³» | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `Keyword` â†’ `Post` | 1:N | ä¸€ä¸ªå…³é”®è¯å¯¹åº”å¤šæ¡å¸–å­ |
| `Keyword` â†’ `OpinionCluster` | 1:N | ä¸€ä¸ªå…³é”®è¯å¯¹åº”å¤šä¸ªè§‚ç‚¹èšç±» |
| `Keyword` â†’ `AnalysisJob` | 1:N | ä¸€ä¸ªå…³é”®è¯å¯å¤šæ¬¡åˆ†æ |
| `Keyword` â†’ `Subscription` | 1:N | ä¸€ä¸ªå…³é”®è¯å¯æœ‰å¤šä¸ªè®¢é˜… |
| `Post` â†’ `OpinionCluster` | 1:1 | ä¸€æ¡å¸–å­å¯ä½œä¸ºæŸä¸ªèšç±»çš„ä»£è¡¨ |
| `Subscription` â†’ `Alert` | 1:N | ä¸€ä¸ªè®¢é˜…å¯è§¦å‘å¤šæ¡å‘Šè­¦ |
| `Keyword` â†’ `Alert` | 1:N | ä¸€ä¸ªå…³é”®è¯å¯æœ‰å¤šæ¡å‘Šè­¦è®°å½• |

---

## 4. è¡¨ç»“æ„è¯¦è§£

### 4.1 keywords è¡¨

**ç”¨é€”**: å­˜å‚¨æœç´¢å…³é”®è¯åŠå…¶æ•´ä½“åˆ†æç»“æœ

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `keyword` | String(255) | UNIQUE, NOT NULL | - | æœç´¢å…³é”®è¯ï¼ˆå¦‚ "iPhone 16"ï¼‰ |
| `language` | String(10) | NOT NULL | 'en' | è¯­è¨€ä»£ç ï¼šen/zh |
| `overall_sentiment` | Float | NULLABLE | NULL | æ•´ä½“æƒ…æ„Ÿåˆ†ï¼ˆ0-100ï¼‰ |
| `summary` | Text | NULLABLE | NULL | AI ç”Ÿæˆçš„è®¨è®ºæ‘˜è¦ |
| `last_analyzed` | DateTime | NULLABLE | NULL | æœ€ååˆ†ææ—¶é—´ |
| `created_at` | DateTime | NOT NULL | NOW() | è®°å½•åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- PRIMARY KEY on `id`
- UNIQUE INDEX on `keyword`

**ä¸šåŠ¡è§„åˆ™**:
- `keyword` å­—æ®µå”¯ä¸€ï¼Œé˜²æ­¢é‡å¤åˆ†æ
- `overall_sentiment` ç”±æ‰€æœ‰ç›¸å…³å¸–å­çš„æƒ…æ„Ÿåˆ†å¹³å‡è®¡ç®—å¾—å‡º
- `summary` å­—æ®µåœ¨ AI åˆ†æå®Œæˆåæ›´æ–°

**ç¤ºä¾‹æ•°æ®**:

```sql
INSERT INTO keywords (keyword, language, overall_sentiment, summary, last_analyzed, created_at)
VALUES
('DeepSeek', 'en', 72.5, 'ç”¨æˆ·æ™®éå¯¹ DeepSeek çš„ç¼–ç¨‹èƒ½åŠ›æ„Ÿåˆ°å…´å¥‹...', '2026-01-17 10:30:00', '2026-01-17 10:00:00'),
('iPhone 16', 'en', 58.2, 'æ··åˆè¯„ä»·ï¼Œç›¸æœºæå‡ä½†ç”µæ± ç»­èˆªå—å…³æ³¨', '2026-01-16 15:45:00', '2026-01-16 15:00:00');
```

---

### 4.2 posts è¡¨

**ç”¨é€”**: å­˜å‚¨ä»å„å¹³å°é‡‡é›†çš„ç¤¾äº¤åª’ä½“å¸–å­

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `platform` | String(50) | NOT NULL | - | å¹³å°ï¼šreddit/youtube/twitter |
| `post_id` | String(255) | NOT NULL | - | å¹³å°åŸå§‹å¸–å­ID |
| `author` | String(255) | NULLABLE | NULL | ä½œè€…/ç”¨æˆ·å |
| `content` | Text | NOT NULL | - | å¸–å­å†…å®¹/å­—å¹•æ–‡æœ¬ |
| `url` | String(2048) | NULLABLE | NULL | åŸå§‹å¸–å­URL |
| `created_at` | DateTime | NOT NULL | NOW() | åŸå‘å¸–æ—¶é—´ |
| `collected_at` | DateTime | NOT NULL | NOW() | é‡‡é›†æ—¶é—´ |
| `upvotes` | Integer | NOT NULL | 0 | Reddit æŠ•ç¥¨æ•° |
| `likes` | Integer | NOT NULL | 0 | YouTube/Twitter ç‚¹èµæ•° |
| `shares` | Integer | NOT NULL | 0 | Twitter è½¬å‘æ•° |
| `comments_count` | Integer | NOT NULL | 0 | è¯„è®ºæ•° |
| `sentiment_score` | Float | NULLABLE | NULL | AI æƒ…æ„Ÿåˆ†ï¼ˆ0-100ï¼‰ |
| `sentiment_label` | String(50) | NULLABLE | NULL | æƒ…æ„Ÿæ ‡ç­¾ï¼špositive/negative/neutral |
| `keyword_id` | Integer | FOREIGN KEY | - | å…³è”å…³é”®è¯ID |

**ç´¢å¼•**:
- PRIMARY KEY on `id`
- INDEX on `keyword_id`
- INDEX on `platform`
- INDEX on `sentiment_score`
- UNIQUE INDEX on `(platform, post_id)` - é˜²æ­¢é‡å¤é‡‡é›†

**ä¸šåŠ¡è§„åˆ™**:
- `(platform, post_id)` ç»„åˆå”¯ä¸€ï¼ŒåŒä¸€å¸–å­ä¸é‡å¤å­˜å‚¨
- ä¸åŒå¹³å°ä½¿ç”¨ä¸åŒçš„ç‚¹èµæ•°å­—æ®µï¼ˆRedditç”¨upvotesï¼ŒYouTubeç”¨likesï¼‰
- `sentiment_score` å’Œ `sentiment_label` åœ¨ AI åˆ†æåå¡«å……

**ç¤ºä¾‹æ•°æ®**:

```sql
INSERT INTO posts (platform, post_id, author, content, url, upvotes, comments_count, sentiment_score, sentiment_label, keyword_id)
VALUES
('reddit', 'abc123', 'user123', 'DeepSeek å¤ªæ£’äº†ï¼ä»£ç ç”Ÿæˆèƒ½åŠ›å¾ˆå¼º', 'https://reddit.com/r/Python/comments/abc123', 150, 45, 85.0, 'positive', 1),
('youtube', 'xyz789', 'TechReviewer', 'è¿™æ¬¾äº§å“çœŸçš„å¾ˆä¸é”™ï¼Œæ¨èå¤§å®¶å°è¯•', 'https://youtube.com/watch?v=xyz789', 0, 120, 72.5, 'positive', 1);
```

---

### 4.3 opinion_clusters è¡¨

**ç”¨é€”**: å­˜å‚¨ AI æå–çš„è§‚ç‚¹èšç±»ç»“æœ

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `keyword_id` | Integer | FOREIGN KEY, NOT NULL | - | å…³è”å…³é”®è¯ID |
| `cluster_label` | String(255) | NOT NULL | - | èšç±»æ ‡ç­¾ï¼ˆå¦‚"ç”µæ± ç»­èˆª"ï¼‰ |
| `cluster_summary` | Text | NOT NULL | - | èšç±»è¯¦ç»†è¯´æ˜ |
| `representative_post_id` | Integer | FOREIGN KEY, NULLABLE | NULL | ä»£è¡¨å¸–å­ID |
| `mention_count` | Integer | NOT NULL | 0 | æåŠæ¬¡æ•° |
| `created_at` | DateTime | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- PRIMARY KEY on `id`
- INDEX on `keyword_id`
- INDEX on `representative_post_id`

**ä¸šåŠ¡è§„åˆ™**:
- æ¯ä¸ªå…³é”®è¯é€šå¸¸æœ‰ 3-5 ä¸ªèšç±»
- `mention_count` è¡¨ç¤ºè¯¥è§‚ç‚¹è¢«å¤šå°‘å¸–å­æåŠ
- `representative_post_id` æŒ‡å‘æœ€èƒ½ä»£è¡¨è¯¥è§‚ç‚¹çš„å¸–å­

**ç¤ºä¾‹æ•°æ®**:

```sql
INSERT INTO opinion_clusters (keyword_id, cluster_label, cluster_summary, representative_post_id, mention_count)
VALUES
(1, 'ä»£ç è´¨é‡', 'ç”¨æˆ·æ™®éèµæ‰¬ DeepSeek çš„ä»£ç ç”Ÿæˆèƒ½åŠ›å’Œå‡†ç¡®æ€§', 5, 32),
(1, 'æ€§èƒ½è¡¨ç°', 'è®¨è®ºå“åº”é€Ÿåº¦å’Œå¤„ç†æ•ˆç‡', 8, 28),
(1, 'API ç¨³å®šæ€§', 'éƒ¨åˆ†ç”¨æˆ·æŠ¥å‘Š API å»¶è¿Ÿå’Œé™æµé—®é¢˜', 12, 15);
```

---

### 4.4 analysis_jobs è¡¨

**ç”¨é€”**: è·Ÿè¸ªåˆ†æä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ï¼Œç”¨äºç›‘æ§å’Œè°ƒè¯•

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `keyword_id` | Integer | FOREIGN KEY, NOT NULL | - | å…³è”å…³é”®è¯ID |
| `status` | String(50) | NOT NULL | 'pending' | çŠ¶æ€ï¼špending/processing/completed/failed |
| `platforms_scraped` | String(255) | NULLABLE | NULL | å·²é‡‡é›†å¹³å°ï¼ˆé€—å·åˆ†éš”ï¼‰ |
| `posts_collected` | Integer | NOT NULL | 0 | é‡‡é›†å¸–å­æ•° |
| `token_used` | Integer | NOT NULL | 0 | æ¶ˆè€— Token æ•° |
| `error_message` | Text | NULLABLE | NULL | é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶ï¼‰ |
| `started_at` | DateTime | NOT NULL | NOW() | ä»»åŠ¡å¼€å§‹æ—¶é—´ |
| `completed_at` | DateTime | NULLABLE | NULL | ä»»åŠ¡å®Œæˆæ—¶é—´ |

**ç´¢å¼•**:
- PRIMARY KEY on `id`
- INDEX on `keyword_id`
- INDEX on `status`
- INDEX on `started_at`

**ä¸šåŠ¡è§„åˆ™**:
- æ¯æ¬¡åˆ†æåˆ›å»ºä¸€æ¡æ–°è®°å½•
- `status` çŠ¶æ€æµè½¬ï¼špending â†’ processing â†’ completed/failed
- `token_used` ç”¨äºæˆæœ¬ç»Ÿè®¡å’Œé¢„ç®—æ§åˆ¶

**ç¤ºä¾‹æ•°æ®**:

```sql
INSERT INTO analysis_jobs (keyword_id, status, platforms_scraped, posts_collected, token_used, started_at, completed_at)
VALUES
(1, 'completed', 'reddit,youtube', 45, 10398, '2026-01-17 10:00:00', '2026-01-17 10:01:30'),
(2, 'failed', 'reddit', 0, 0, '2026-01-16 14:00:00', NULL);
```

---

### 4.5 subscriptions è¡¨

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·çš„å…³é”®è¯è®¢é˜…é…ç½®

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `keyword_id` | Integer | FOREIGN KEY, NOT NULL | - | å…³è”å…³é”®è¯ID |
| `platforms` | String(255) | NULLABLE | NULL | ç›‘æ§å¹³å°ï¼ˆé€—å·åˆ†éš”ï¼‰ |
| `language` | String(10) | NOT NULL | 'en' | è¯­è¨€ä»£ç  |
| `post_limit` | Integer | NOT NULL | 50 | æ¯æ¬¡é‡‡é›†å¸–å­æ•°ä¸Šé™ |
| `alert_threshold` | Float | NOT NULL | 30.0 | å‘Šè­¦é˜ˆå€¼ï¼ˆæƒ…æ„Ÿåˆ† < æ­¤å€¼è§¦å‘ï¼‰ |
| `interval_hours` | Integer | NOT NULL | 6 | æ£€æŸ¥é—´éš”ï¼ˆå°æ—¶ï¼‰ |
| `is_active` | Boolean | NOT NULL | TRUE | æ˜¯å¦æ¿€æ´» |
| `created_at` | DateTime | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |
| `last_checked_at` | DateTime | NULLABLE | NULL | æœ€åæ£€æŸ¥æ—¶é—´ |
| `next_check_at` | DateTime | NULLABLE | NULL | ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´ |
| `user_email` | String(255) | NULLABLE | NULL | ç”¨æˆ·é‚®ç®±ï¼ˆå‘é€å‘Šè­¦ï¼‰ |

**ç´¢å¼•**:
- PRIMARY KEY on `id`
- INDEX on `keyword_id`
- INDEX on `is_active`
- INDEX on `next_check_at`

**ä¸šåŠ¡è§„åˆ™**:
- è½¯åˆ é™¤ï¼šå°† `is_active` è®¾ä¸º FALSE
- `next_check_at` ç”±è°ƒåº¦å™¨æ ¹æ® `interval_hours` è‡ªåŠ¨è®¡ç®—
- åŒä¸€å…³é”®è¯åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒè®¢é˜…

**ç¤ºä¾‹æ•°æ®**:

```sql
INSERT INTO subscriptions (keyword_id, platforms, language, post_limit, alert_threshold, interval_hours, next_check_at, user_email)
VALUES
(3, 'reddit,youtube', 'en', 50, 30.0, 6, '2026-01-17 16:00:00', 'user@example.com');
```

---

### 4.6 alerts è¡¨

**ç”¨é€”**: å­˜å‚¨æƒ…æ„Ÿå‘Šè­¦è®°å½•

| å­—æ®µå | ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|--------|------|
| `id` | Integer | PRIMARY KEY, AUTO_INCREMENT | - | å”¯ä¸€æ ‡è¯†ç¬¦ |
| `subscription_id` | Integer | FOREIGN KEY, NOT NULL | - | å…³è”è®¢é˜…ID |
| `keyword_id` | Integer | FOREIGN KEY, NOT NULL | - | å…³è”å…³é”®è¯ID |
| `sentiment_score` | Float | NOT NULL | - | è§¦å‘å‘Šè­¦çš„æƒ…æ„Ÿåˆ† |
| `sentiment_label` | String(50) | NULLABLE | NULL | æƒ…æ„Ÿæ ‡ç­¾ |
| `posts_count` | Integer | NOT NULL | 0 | åˆ†æå¸–å­æ€»æ•° |
| `negative_posts_count` | Integer | NOT NULL | 0 | è´Ÿé¢å¸–å­æ•° |
| `summary` | Text | NULLABLE | NULL | å‘Šè­¦æ‘˜è¦è¯´æ˜ |
| `top_negative_posts` | Text | NULLABLE | NULL | æœ€å·®å¸–å­IDï¼ˆJSONæ•°ç»„ï¼‰ |
| `is_sent` | Boolean | NOT NULL | FALSE | æ˜¯å¦å·²å‘é€é€šçŸ¥ |
| `sent_at` | DateTime | NULLABLE | NULL | å‘é€æ—¶é—´ |
| `created_at` | DateTime | NOT NULL | NOW() | åˆ›å»ºæ—¶é—´ |
| `acknowledged_at` | DateTime | NULLABLE | NULL | ç¡®è®¤æ—¶é—´ |

**ç´¢å¼•**:
- PRIMARY KEY on `id`
- INDEX on `subscription_id`
- INDEX on `keyword_id`
- INDEX on `is_sent`
- INDEX on `created_at`

**ä¸šåŠ¡è§„åˆ™**:
- å½“æƒ…æ„Ÿåˆ† < `alert_threshold` æ—¶è‡ªåŠ¨åˆ›å»º
- `acknowledged_at` ä¸º NULL è¡¨ç¤ºæœªç¡®è®¤
- `top_negative_posts` å­˜å‚¨æœ€è´Ÿé¢å¸–å­çš„IDåˆ—è¡¨

**ç¤ºä¾‹æ•°æ®**:

```sql
INSERT INTO alerts (subscription_id, keyword_id, sentiment_score, sentiment_label, posts_count, negative_posts_count, summary, is_sent)
VALUES
(1, 3, 25.5, 'negative', 50, 35, 'æ£€æµ‹åˆ°å¤§é‡è´Ÿé¢è¯„ä»·ï¼Œä¸»è¦é—®é¢˜é›†ä¸­åœ¨ç”µæ± ç»­èˆª', TRUE);
```

---

## 5. ç´¢å¼•è®¾è®¡

### 5.1 å½“å‰ç´¢å¼•

```sql
-- keywords è¡¨
CREATE UNIQUE INDEX idx_keyword_keyword ON keywords(keyword);

-- posts è¡¨
CREATE INDEX idx_post_keyword ON posts(keyword_id);
CREATE INDEX idx_post_platform ON posts(platform);
CREATE INDEX idx_post_sentiment ON posts(sentiment_score);
CREATE UNIQUE INDEX idx_post_unique ON posts(platform, post_id);

-- opinion_clusters è¡¨
CREATE INDEX idx_cluster_keyword ON opinion_clusters(keyword_id);
CREATE INDEX idx_cluster_representative ON opinion_clusters(representative_post_id);

-- analysis_jobs è¡¨
CREATE INDEX idx_job_keyword ON analysis_jobs(keyword_id);
CREATE INDEX idx_job_status ON analysis_jobs(status);
CREATE INDEX idx_job_started ON analysis_jobs(started_at);

-- subscriptions è¡¨
CREATE INDEX idx_subscription_keyword ON subscriptions(keyword_id);
CREATE INDEX idx_subscription_active ON subscriptions(is_active);
CREATE INDEX idx_subscription_next_check ON subscriptions(next_check_at);

-- alerts è¡¨
CREATE INDEX idx_alert_subscription ON alerts(subscription_id);
CREATE INDEX idx_alert_keyword ON alerts(keyword_id);
CREATE INDEX idx_alert_sent ON alerts(is_sent);
CREATE INDEX idx_alert_created ON alerts(created_at);
```

### 5.2 ç´¢å¼•ä½¿ç”¨å»ºè®®

**æŸ¥è¯¢åœºæ™¯**:

| æŸ¥è¯¢ç±»å‹ | ä½¿ç”¨ç´¢å¼• | ç¤ºä¾‹ |
|---------|---------|------|
| æŒ‰å…³é”®è¯æŸ¥å¸–å­ | `idx_post_keyword` | `WHERE keyword_id = ?` |
| æŒ‰å¹³å°ç­›é€‰ | `idx_post_platform` | `WHERE platform = 'reddit'` |
| æƒ…æ„Ÿåˆ†èŒƒå›´æŸ¥è¯¢ | `idx_post_sentiment` | `WHERE sentiment_score < 30` |
| é˜²é‡æŸ¥è¯¢ | `idx_post_unique` | `WHERE platform = ? AND post_id = ?` |
| å¾…æ‰§è¡Œè®¢é˜… | `idx_subscription_next_check` | `WHERE next_check_at < NOW()` |
| æœªå‘é€å‘Šè­¦ | `idx_alert_sent` | `WHERE is_sent = FALSE` |

---

## 6. æ•°æ®æµ

### 6.1 åˆ†ææµç¨‹æ•°æ®æµ

```mermaid
flowchart TD
    A[ç”¨æˆ·è¯·æ±‚åˆ†æ] --> B[åˆ›å»º/è·å– Keyword è®°å½•]
    B --> C[é‡‡é›†å¹³å°æ•°æ®]
    C --> D[æ‰¹é‡åˆ›å»º Post è®°å½•]
    D --> E[åˆ›å»º AnalysisJob<br/>status=processing]
    E --> F[AI æƒ…æ„Ÿåˆ†æ]
    F --> G[æ›´æ–° Post.sentiment_score]
    G --> H[AI è§‚ç‚¹èšç±»]
    H --> I[åˆ›å»º OpinionCluster è®°å½•]
    I --> J[AI ç”Ÿæˆæ‘˜è¦]
    J --> K[æ›´æ–° Keyword.overall_sentiment<br/>Keyword.summary]
    K --> L[æ›´æ–° AnalysisJob<br/>status=completed]
    L --> M[è¿”å›ç»“æœ]

    style A fill:#e1f5ff
    style M fill:#c8e6c9
```

### 6.2 è®¢é˜…ç›‘æ§æ•°æ®æµ

```mermaid
flowchart TD
    A[åˆ›å»º Subscription] --> B[è°ƒåº¦å™¨å®šæœŸæ£€æŸ¥]
    B --> C{next_check_at < NOW?}
    C -->|æ˜¯| D[æ‰§è¡Œåˆ†æ]
    C -->|å¦| B
    D --> E{sentiment < threshold?}
    E -->|æ˜¯| F[åˆ›å»º Alert è®°å½•]
    E -->|å¦| G[æ›´æ–° next_check_at]
    F --> H[å‘é€é€šçŸ¥]
    H --> G
    G --> B

    style A fill:#e1f5ff
    style F fill:#ffcdd2
```

---

## 7. SQL ç¤ºä¾‹

### 7.1 åŸºç¡€æŸ¥è¯¢

#### æŸ¥è¯¢å…³é”®è¯çš„æ‰€æœ‰å¸–å­

```sql
SELECT
    p.id,
    p.platform,
    p.author,
    SUBSTR(p.content, 1, 100) as content_preview,
    p.sentiment_score,
    p.sentiment_label,
    p.upvotes,
    p.likes,
    p.comments_count
FROM posts p
WHERE p.keyword_id = 1
ORDER BY p.created_at DESC
LIMIT 20;
```

#### æŸ¥è¯¢æƒ…æ„Ÿåˆ†ä½äºé˜ˆå€¼çš„å¸–å­

```sql
SELECT
    p.id,
    k.keyword,
    p.platform,
    p.author,
    p.content,
    p.sentiment_score
FROM posts p
JOIN keywords k ON p.keyword_id = k.id
WHERE p.sentiment_score < 30
ORDER BY p.sentiment_score ASC;
```

#### ç»Ÿè®¡å„å¹³å°å¸–å­æ•°

```sql
SELECT
    platform,
    COUNT(*) as post_count,
    AVG(sentiment_score) as avg_sentiment
FROM posts
WHERE keyword_id = 1
GROUP BY platform;
```

### 7.2 å¤æ‚æŸ¥è¯¢

#### è·å–å…³é”®è¯å®Œæ•´åˆ†ææŠ¥å‘Š

```sql
-- 1. å…³é”®è¯ä¿¡æ¯
SELECT * FROM keywords WHERE id = 1;

-- 2. è§‚ç‚¹èšç±»
SELECT
    cluster_label,
    cluster_summary,
    mention_count
FROM opinion_clusters
WHERE keyword_id = 1
ORDER BY mention_count DESC;

-- 3. æƒ…æ„Ÿåˆ†å¸ƒ
SELECT
    sentiment_label,
    COUNT(*) as count,
    ROUND(AVG(sentiment_score), 2) as avg_score
FROM posts
WHERE keyword_id = 1 AND sentiment_score IS NOT NULL
GROUP BY sentiment_label;

-- 4. æœ€è´Ÿé¢å¸–å­
SELECT
    platform,
    author,
    content,
    sentiment_score
FROM posts
WHERE keyword_id = 1
ORDER BY sentiment_score ASC
LIMIT 5;
```

#### æŸ¥è¯¢éœ€è¦æ‰§è¡Œçš„è®¢é˜…

```sql
SELECT
    s.id,
    k.keyword,
    s.platforms,
    s.interval_hours
FROM subscriptions s
JOIN keywords k ON s.keyword_id = k.id
WHERE s.is_active = TRUE
  AND s.next_check_at <= datetime('now')
ORDER BY s.next_check_at ASC;
```

#### æŸ¥è¯¢æœªç¡®è®¤çš„å‘Šè­¦

```sql
SELECT
    a.id,
    k.keyword,
    a.sentiment_score,
    a.sentiment_label,
    a.posts_count,
    a.negative_posts_count,
    a.created_at
FROM alerts a
JOIN keywords k ON a.keyword_id = k.id
WHERE a.acknowledged_at IS NULL
ORDER BY a.created_at DESC;
```

### 7.3 æ•°æ®ç»´æŠ¤

#### æ¸…ç†æ—§çš„åˆ†æä»»åŠ¡

```sql
-- ä¿ç•™æœ€è¿‘ 100 æ¡ä»»åŠ¡è®°å½•
DELETE FROM analysis_jobs
WHERE id NOT IN (
    SELECT id
    FROM analysis_jobs
    ORDER BY started_at DESC
    LIMIT 100
);
```

#### åˆ é™¤æ— å¸–å­çš„å…³é”®è¯

```sql
DELETE FROM keywords
WHERE id NOT IN (
    SELECT DISTINCT keyword_id
    FROM posts
);
```

#### å½’æ¡£æ—§æ•°æ®ï¼ˆå¯é€‰ï¼‰

```sql
-- åˆ›å»ºå½’æ¡£è¡¨
CREATE TABLE posts_archive AS SELECT * FROM posts WHERE created_at < date('now', '-30 days');

-- åˆ é™¤å·²å½’æ¡£æ•°æ®
DELETE FROM posts WHERE created_at < date('now', '-30 days');
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 æŸ¥è¯¢ä¼˜åŒ–

#### ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è¯¢

```sql
EXPLAIN QUERY PLAN
SELECT * FROM posts
WHERE keyword_id = 1 AND sentiment_score < 30;
```

#### é¿å…å…¨è¡¨æ‰«æ

```sql
-- BAD: å…¨è¡¨æ‰«æ
SELECT * FROM posts WHERE LOWER(content) LIKE '%deepseek%';

-- GOOD: ä½¿ç”¨ FTS5ï¼ˆéœ€æå‰åˆ›å»ºï¼‰
SELECT * FROM posts WHERE content MATCH 'DeepSeek';
```

### 8.2 æ‰¹é‡æ’å…¥ä¼˜åŒ–

```python
# ä½¿ç”¨ SQLAlchemy æ‰¹é‡æ’å…¥
from sqlalchemy import insert

# æ–¹å¼1: bulk_insert_mappings (æ›´å¿«)
stmt = insert(Post).values(posts_data)
await session.execute(stmt)

# æ–¹å¼2: bulk_save_objects (æ”¯æŒå…³ç³»)
session.bulk_save_objects(post_objects, return_defaults=True)
```

### 8.3 è¿æ¥æ± é…ç½®

```python
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=5,          # è¿æ¥æ± å¤§å°
    max_overflow=10,      # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
    pool_timeout=30,      # è·å–è¿æ¥è¶…æ—¶
    pool_recycle=3600,    # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
)
```

### 8.4 åˆ†é¡µæŸ¥è¯¢

```python
# ä½¿ç”¨ LIMIT å’Œ OFFSET åˆ†é¡µ
async def get_posts_paginated(keyword_id: int, page: int, page_size: int = 20):
    offset = (page - 1) * page_size

    stmt = (
        select(Post)
        .where(Post.keyword_id == keyword_id)
        .order_by(Post.created_at.desc())
        .limit(page_size)
        .offset(offset)
    )

    result = await session.execute(stmt)
    return result.scalars().all()
```

---

## 9. å¤‡ä»½ä¸æ¢å¤

### 9.1 SQLite å¤‡ä»½

#### æ–¹å¼1: æ–‡ä»¶å¤åˆ¶

```bash
# ç®€å•å¤‡ä»½ï¼ˆåœæ­¢æœåŠ¡åï¼‰
cp trendpulse.db trendpulse_backup_$(date +%Y%m%d).db

# æ¢å¤
cp trendpulse_backup_20260117.db trendpulse.db
```

#### æ–¹å¼2: SQL å¯¼å‡º

```bash
# å¯¼å‡ºä¸º SQL æ–‡ä»¶
sqlite3 trendpulse.db .dump > backup_$(date +%Y%m%d).sql

# ä» SQL æ¢å¤
sqlite3 trendpulse.db < backup_20260117.sql
```

#### æ–¹å¼3: åœ¨çº¿å¤‡ä»½ï¼ˆPythonï¼‰

```python
import sqlite3
import shutil
from datetime import datetime

def backup_database(db_path: str, backup_dir: str = "./backups"):
    """åœ¨çº¿å¤‡ä»½æ•°æ®åº“"""
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_path = f"{backup_dir}/trendpulse_{timestamp}.db"

    # SQLite åœ¨çº¿å¤‡ä»½ API
    source = sqlite3.connect(db_path)
    dest = sqlite3.connect(backup_path)
    source.backup(dest)
    dest.close()
    source.close()

    print(f"Database backed up to: {backup_path}")

# ä½¿ç”¨
backup_database("./trendpulse.db")
```

### 9.2 è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup.sh - æ¯æ—¥è‡ªåŠ¨å¤‡ä»½è„šæœ¬

BACKUP_DIR="./backups"
DB_FILE="./trendpulse.db"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/trendpulse_$TIMESTAMP.db"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
sqlite3 $DB_FILE ".backup $BACKUP_FILE"

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_FILE

# åˆ é™¤ 30 å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "trendpulse_*.db.gz" -mtime +30 -delete

echo "Backup completed: trendpulse_$TIMESTAMP.db.gz"
```

**è®¾ç½®å®šæ—¶ä»»åŠ¡**:

```bash
# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œï¼‰
0 2 * * * /path/to/backup.sh >> /var/log/trendpulse_backup.log 2>&1
```

### 9.3 PostgreSQL å¤‡ä»½ï¼ˆè¿ç§»åï¼‰

```bash
# å¤‡ä»½
pg_dump -U username -d trendpulse > backup_$(date +%Y%m%d).sql

# æ¢å¤
psql -U username -d trendpulse < backup_20260117.sql
```

---

## 10. è¿ç§»æŒ‡å—

### 10.1 SQLite â†’ PostgreSQL

#### æ­¥éª¤1: å®‰è£…ä¾èµ–

```bash
pip install asyncpg psycopg2-binary
```

#### æ­¥éª¤2: åˆ›å»º PostgreSQL æ•°æ®åº“

```bash
# è¿æ¥åˆ° PostgreSQL
psql -U postgres

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE trendpulse;
CREATE USER trendpulse_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE trendpulse TO trendpulse_user;
```

#### æ­¥éª¤3: è¿ç§»æ•°æ®

```python
# migrate_to_postgres.py
import asyncio
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker

# æºæ•°æ®åº“ï¼ˆSQLiteï¼‰
source_engine = create_engine("sqlite:///./trendpulse.db")
SourceSession = sessionmaker(bind=source_engine)

# ç›®æ ‡æ•°æ®åº“ï¼ˆPostgreSQLï¼‰
dest_engine = create_engine("postgresql+psycopg2://trendpulse_user:password@localhost/trendpulse")

# è¿ç§»å‡½æ•°
async def migrate_data():
    source_session = SourceSession()

    # 1. è¿ç§» keywords
    keywords = source_session.execute("SELECT * FROM keywords").fetchall()
    for kw in keywords:
        dest_engine.execute(
            f"INSERT INTO keywords VALUES ({kw})"
        )

    # 2. è¿ç§» posts
    posts = source_session.execute("SELECT * FROM posts").fetchall()
    for post in posts:
        dest_engine.execute(
            f"INSERT INTO posts VALUES ({post})"
        )

    # ... å…¶ä»–è¡¨

    source_session.close()
    print("Migration completed!")

# æ‰§è¡Œè¿ç§»
asyncio.run(migrate_data())
```

#### æ­¥éª¤4: æ›´æ–°é…ç½®

```python
# config.py
DATABASE_URL = "postgresql+asyncpg://trendpulse_user:password@localhost/trendpulse"
```

---

## 11. ç›‘æ§ä¸ç»´æŠ¤

### 11.1 æ•°æ®åº“å¥åº·æ£€æŸ¥

```python
async def health_check(db: DatabaseManager):
    """æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€"""
    try:
        # æµ‹è¯•è¿æ¥
        keyword_count = await db.get_all_keywords()
        post_count = await db.get_posts_count()

        return {
            "status": "healthy",
            "keywords": len(keyword_count),
            "posts": post_count,
            "db_size_mb": get_db_size()
        }
    except Exception as e:
        return {
            "status": "unhealthy",
            "error": str(e)
        }

def get_db_size(db_path: str = "./trendpulse.db") -> float:
    """è·å–æ•°æ®åº“æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰"""
    import os
    size_bytes = os.path.getsize(db_path)
    return round(size_bytes / (1024 * 1024), 2)
```

### 11.2 æ€§èƒ½ç›‘æ§

```python
import time
from contextlib import contextmanager

@contextmanager
def query_timer():
    """æŸ¥è¯¢è®¡æ—¶å™¨"""
    start = time.time()
    yield
    duration = time.time() - start
    if duration > 1.0:  # è¶…è¿‡ 1 ç§’è®°å½•æ—¥å¿—
        logger.warning(f"Slow query: {duration:.2f}s")

# ä½¿ç”¨
with query_timer():
    result = await session.execute(query)
```

### 11.3 å®šæœŸç»´æŠ¤ä»»åŠ¡

```python
async def maintenance_tasks():
    """å®šæœŸç»´æŠ¤ä»»åŠ¡"""

    # 1. æ¸…ç†æ—§ä»»åŠ¡è®°å½•
    await cleanup_old_jobs(days=7, keep_last=100)

    # 2. åˆ é™¤å­¤ç«‹å…³é”®è¯
    await delete_orphaned_keywords()

    # 3. é‡å»ºç´¢å¼•
    await rebuild_indexes()

    # 4. åˆ†æè¡¨ï¼ˆSQLiteï¼‰
    await session.execute("ANALYZE")
    await session.commit()

    logger.info("Maintenance completed")
```

---

## é™„å½•

### A. æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

```python
# init_db.py
import asyncio
from src.database.operations import DatabaseManager
from src.config import Config

async def main():
    db = DatabaseManager(Config.DATABASE_URL)
    await db.init_db()
    print("Database initialized successfully!")

if __name__ == "__main__":
    asyncio.run(main())
```

### B. å¸¸ç”¨ SQL å‘½ä»¤é€ŸæŸ¥

```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
SELECT name FROM sqlite_master WHERE type='table';

-- æŸ¥çœ‹è¡¨ç»“æ„
PRAGMA table_info(posts);

-- æŸ¥çœ‹ç´¢å¼•
SELECT name FROM sqlite_master WHERE type='index';

-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT page_count * page_size as size FROM pragma_page_count(), pragma_page_size();

-- ä¼˜åŒ–æ•°æ®åº“
VACUUM;

-- åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE;
```

### C. æ•…éšœæ’æŸ¥

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| `database is locked` | SQLite å¹¶å‘å†™å…¥ | ä½¿ç”¨è¿æ¥æ± æˆ–è¿ç§»åˆ° PostgreSQL |
| `FOREIGN KEY constraint failed` | çˆ¶è®°å½•ä¸å­˜åœ¨ | å…ˆåˆ›å»ºçˆ¶è®°å½•å†åˆ›å»ºå­è®°å½• |
| `UNIQUE constraint failed` | é‡å¤æ’å…¥ | æ£€æŸ¥å”¯ä¸€çº¦æŸå­—æ®µ |
| æŸ¥è¯¢æ…¢ | ç¼ºå°‘ç´¢å¼• | æ·»åŠ åˆé€‚çš„ç´¢å¼• |
| æ•°æ®åº“æ–‡ä»¶è¿‡å¤§ | æœªæ¸…ç†æ—§æ•°æ® | å®šæœŸæ¸…ç†æˆ–å½’æ¡£ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-17
**ç»´æŠ¤è€…**: TrendPulse Team
